title = "Checkout2"
url = "/checkout2/:id?"
layout = "layout"
is_hidden = 0

[session]
security = "user"
redirect = "inicio"
==
<?php
use Andresalice\Winelivery\Models\Cart;
use Andresalice\Winelivery\Models\Address;
use Andresalice\Winelivery\Models\Order;

function onStart()
{
    $exists = Cart::where("user_id",Auth::getUser()->id)->exists();
    if($exists)
    {
        $cart = Cart::where("user_id",Auth::getUser()->id)->get();
        $sum = 0;
        foreach($cart as $c){ $sum += $c->product->price * $c->quantity; }
        $this['products'] = $cart; 
        $this['address'] = Address::find($this->param('id'));
        $address = "Sector: " . $this['address']->sector . " Calle: " . $this['address']->calle . " Residencial: " . $this['address']->residencial . " No.:" . $this['address']->numero . " Proximo a: " . $this['address']->proximo;
        
        $sum = $sum + 90;
        $user = Auth::getUser();
        $order = new Order();
        $order->user_id = $user->id;
        $order->name = $user->name;
        $order->surname = $user->surname;
        $order->email = $user->username;
        $order->address = $address;
        $order->telefono = $this['address']->telefono;
        $order->celular = $this['address']->celular;
        $order->total = "RD$" . $sum;
        $order->status = "Procesando Orden";
        $order->save();
        
        foreach($cart as $c)
        {
            DB::table("product_order")->insert(['order_id' => $order->id, 'product_id' => $c->product_id, 'quantity' => $c->quantity]);
        }
        $this['cart_total'] = $sum;
        $this['cart_total_envio'] = $sum + 90;
        
        $this['cart_counter'] = Cart::where("user_id","=",Auth::getUser()->id)->select(DB::raw('sum(quantity) as cart_counter'))->first()->cart_counter;
        Cart::where("user_id",Auth::getUser()->id)->delete();
    }
    else
    {
        return Redirect::to('historial');
    }
    
}
?>
==
<!-- Main Content -->
    <div class="container m-t-3">
      <div class="row">
        <div class="title"><span>Recibo de pago</span></div>
        <div class="alert alert-success" role="alert">Tu pedido fue realizado correctamente</div>
        <!-- Shopping Cart List -->
        <div class="col-md-8">

          <div class="table-responsive">
            <table class="table table-cart">
              <thead>
                <tr>
                  <th></th>
                  <th></th>
                  <th>Cantidad</th>
                  <th>Precio</th>
                  <th>SubTotal</th>
                </tr>
              </thead>
              <tbody>
                {% for p in products %}
                <tr>
                  <td class="img-cart">
                    <a href="{{"producto-detalle"|page({id:p.product.id})}}">
                      <img alt="Product" src="{{p.product.featured_image.getPath}}" class="img-thumbnail">
                    </a>
                  </td>
                  <td>
                    <p><a href="{{"producto-detalle"|page({id:p.product.id})}}" class="d-block">{{p.product.title}}</a></p>
                  </td>
                   <td>{{p.quantity}}</td>
                   <td class="unit">RD${{p.product.price|number_format}}</td>
                   <td class="sub">{% set sub = p.product.price * p.quantity %}RD${{sub|number_format}}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        <!-- End Shopping Cart List -->
        <div class="col-md-3 cart-detailbox">
          <h4>Orden de Compra</h4>
          <p class="detailbox-items">Dirección:<span class="detailbox-content">{{address.sector}} {{address.calle}} {{address.residencial}} {{address.numero}} {{address.telefono}} {{address.celular}} {{address.proximo}}</span></p>
          <p class="detailbox-items">Total items:<span class="detailbox-content">{{cart_counter}}</span></p>
          <p class="detailbox-items">Costo:<span class="detailbox-content" >RD${{ cart_total|number_format}}</span></p>
          <p class="detailbox-items">Costo de Envío:<span class="detailbox-content"> $90</span></p>
          <p class="detailbox-items">Costo Total:<span class="detailbox-content">RD${{ cart_total_envio|number_format}}</span></p>

        </div>

      </div>
    </div>